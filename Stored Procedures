-- stored_procedures.sql

-- 20. Stored Procedure: AddDoctor
CREATE OR REPLACE PROCEDURE AddDoctor(
    doctor_id VARCHAR(10),
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    specialization VARCHAR(50),
    email VARCHAR(100),
    phone_number VARCHAR(15)
)
LANGUAGE SQL
AS $$
INSERT INTO Doctors ("DoctorID", "FirstName", "LastName", "Specialization", "Email", "PhoneNumber")
VALUES (doctor_id, first_name, last_name, specialization, email, phone_number);
$$;

-- Example call
CALL AddDoctor(
    'D1001',
    'Sarah', 
    'Johnson', 
    'Cardiology', 
    's.johnson@example.com', 
    '555-123-4567'
);


-- 21. Stored Procedure: AddAppointmentWithValidation
CREATE OR REPLACE PROCEDURE AddAppointmentWithValidation(
    appointment_id VARCHAR(30),
    patient_id VARCHAR(32),
    doctor_id VARCHAR(50),
    appointment_date TIMESTAMP,
    status VARCHAR(20),
    nurse_id VARCHAR(10)
)
LANGUAGE plpgsql
AS $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM Patients WHERE "PatientID" = patient_id) THEN
        RAISE EXCEPTION 'Patient with ID % does not exist', patient_id;
    END IF;

    IF NOT EXISTS (SELECT 1 FROM Doctors WHERE "DoctorID" = doctor_id) THEN
        RAISE EXCEPTION 'Doctor with ID % does not exist', doctor_id;
    END IF;

    INSERT INTO Appointments ("AppointmentID", "PatientID", "DoctorID", "AppointmentDate", "Status", "NurseID")
    VALUES (appointment_id, patient_id, doctor_id, appointment_date, status, nurse_id);

    RAISE NOTICE 'Appointment % successfully created for patient % with doctor %', 
        appointment_id, patient_id, doctor_id;
END;
$$;

-- Example call
CALL AddAppointmentWithValidation(
    'A1001',
    'P0938', 
    'D0050',
    '2024-01-15 10:30:00',
    'Scheduled',
    'N0100'
);
